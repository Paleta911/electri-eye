<div class="container1">
  <!-- Sede selector + Acciones globales -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div class="d-flex align-items-center gap-3">
      <label for="sedeSelector" class="form-label fw-semibold fs-5 mb-0">Selecciona una sede:</label>
      <select
        id="sedeSelector"
        class="form-select w-auto px-3 py-2 shadow-sm border-secondary rounded-3"
        [(ngModel)]="sedeSeleccionada"
        (change)="cargarCamaras()"
      >
        <option *ngFor="let sede of sedes" [value]="sede.id">{{ sede.nombre }}</option>
      </select>
    </div>

    <!-- Botones globales -->
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-outline-primary btn-sm" (click)="alternarVista()">
        <i class="fas fa-th-large me-1"></i> {{ vistaCompacta ? 'Vista est√°ndar' : 'Vista compacta' }}
      </button>
      <button class="btn btn-outline-secondary btn-sm" (click)="recargarTodo()">
        <i class="fas fa-sync-alt me-1"></i> Recargar
      </button>
      <button class="btn btn-outline-success btn-sm" (click)="agregarCamara()">
        <i class="fas fa-plus me-1"></i> Agregar c√°mara
      </button>
      <button class="btn btn-outline-dark btn-sm" (click)="exportarListado()">
        <i class="fas fa-file-export me-1"></i> Exportar listado
      </button>
    </div>
  </div>

  <!-- Sin c√°maras -->
  <div *ngIf="camaras.length === 0" class="alert alert-warning text-center rounded-3">
    üì≠ No hay c√°maras registradas en esta sede.
  </div>

  <!-- C√°maras -->
  <div class="row g-4">
    <ng-container *ngFor="let cam of camaras; let i = index">
      <div [ngClass]="vistaCompacta ? 'col-6 col-md-3' : 'col-12 col-sm-6 col-md-4'">
        <div
          [routerLink]="cam.estado === 'enLinea' ? ['../camara', cam.id] : null"
          [ngClass]="{
            'card camera-card shadow-sm hover-card h-100 text-dark': true,
            'bg-light border-success': cam.estado === 'enLinea',
            'bg-white border border-1 border-secondary text-muted opacity-75': cam.estado !== 'enLinea',
            'cursor-pointer': cam.estado === 'enLinea'
          }"
        >
          <!-- Vista previa -->
          <div class="position-relative rounded-top" style="height: 180px; overflow: hidden;">
            <div
              *ngIf="imagenCargando[cam.id]"
              class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-light"
            >
              <div class="spinner-border text-primary" role="status"></div>
            </div>

            <img
              *ngIf="!imagenError[cam.id]"
              [src]="getSnapshotUrl(cam.id)"
              alt="Vista previa c√°mara"
              class="w-100 h-100 object-fit-cover"
              (load)="imagenCargando[cam.id] = false"
              (error)="imagenCargando[cam.id] = false; imagenError[cam.id] = true"
            />

            <div
              *ngIf="imagenError[cam.id]"
              class="d-flex justify-content-center align-items-center bg-secondary text-white"
              style="height: 100%; width: 100%; font-size: 14px;"
            >
              ‚ùå Sin vista previa
            </div>
          </div>

          <!-- Contenido tarjeta -->
          <div class="card-body px-3 py-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <h5 class="mb-0">C√°mara {{ cam.id }}</h5>
              <span class="dot"
                [ngClass]="{
                  'bg-success': cam.estado === 'enLinea',
                  'bg-secondary': cam.estado !== 'enLinea'
                }"
              ></span>
            </div>

            <span
              class="badge rounded-pill px-3 py-1 mb-3"
              [ngClass]="{
                'bg-success text-white': cam.estado === 'enLinea',
                'bg-secondary text-light': cam.estado !== 'enLinea'
              }"
            >
              {{ cam.estado === 'enLinea' ? 'En l√≠nea' : 'Fuera de l√≠nea' }}
            </span>

            <!-- Normal -->
            <div *ngIf="!cam.editando" (click)="$event.stopPropagation()">
              <p class="card-text small text-dark mb-2">
                <strong>Ubicaci√≥n:</strong> {{ cam.ubicacion }}
              </p>
              <button class="btn btn-sm btn-outline-primary" (click)="editarUbicacion(i, $event)">
                <i class="bi bi-pencil-square me-1"></i> Editar
              </button>
            </div>

            <!-- Edici√≥n -->
            <div *ngIf="cam.editando" (click)="$event.stopPropagation()">
              <label class="form-label small mb-1">Nueva ubicaci√≥n</label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="cam.ubicacion" />
              <button class="btn btn-sm btn-success mt-2" (click)="guardarUbicacion(i, $event)">
                Guardar
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>
